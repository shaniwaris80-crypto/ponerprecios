<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ARSLAN ‚Äî Precios externos (M√≥vil)</title>

  <!-- Fuente Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>

  <!-- LZ-String para descomprimir ?data=... -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

  <style>
    :root{
      --ink:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --bg:#f9fafb;
      --panel:#ffffff;
      --accent:#16a34a;
      --accent-2:#15803d;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family:'Poppins',system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      padding:12px;
    }
    @media(min-width:768px){
      body{padding:16px 24px;}
    }
    h1{font-size:20px;margin:0 0 4px}
    .meta{font-size:12px;color:var(--muted);margin-bottom:12px}
    .card{
      background:var(--panel);
      border-radius:14px;
      border:1px solid var(--border);
      box-shadow:0 2px 6px rgba(0,0,0,.04);
      padding:12px;
      margin-bottom:12px;
    }
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:10px;
    }
    button{
      border-radius:10px;
      border:1px solid var(--border);
      padding:8px 12px;
      font-size:13px;
      background:#fff;
      color:var(--ink);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
      touch-action:manipulation;
    }
    button.primary{
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      border-color:var(--accent-2);
      color:#fff;
    }
    button.danger{
      border-color:#fecaca;
      color:#b91c1c;
      background:#fef2f2;
    }
    input[type="text"]{
      border-radius:10px;
      border:1px solid var(--border);
      padding:8px 10px;
      font-size:14px;
      width:100%;
      background:#fefefe;
    }
    input::placeholder{
      color:#9ca3af;
    }
    .filter-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:10px;
    }
    .filter-row > div{flex:1 1 160px}
    .hint{font-size:12px;color:var(--muted)}
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th,td{
      border:1px solid var(--border);
      padding:6px;
      vertical-align:top;
    }
    th{
      background:#eef2ff;
      text-transform:uppercase;
      letter-spacing:.05em;
      font-size:11px;
    }
    td.num{text-align:right}
    .tag{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:11px;
      border:1px solid var(--border);
      background:#fff;
      white-space:nowrap;
    }
    .tag.prov{
      background:#ecfdf5;
      border-color:#bbf7d0;
      color:#166534;
    }
    .tag.unassigned{
      background:#fefce8;
      border-color:#facc15;
      color:#854d0e;
    }
    .badge{
      display:inline-block;
      padding:2px 6px;
      font-size:11px;
      border-radius:999px;
      background:#11182708;
      color:var(--muted);
      margin-right:4px;
    }
    .totals{
      margin-top:8px;
      font-size:12px;
      color:#374151;
    }
    .no-print{ }
    @media print{
      .no-print{display:none}
      body{padding:10mm}
      .card{border:none;box-shadow:none;padding:0;margin-bottom:6px}
      button{display:none}
      input{border:none}
      /* ‚ö†Ô∏è Solo imprimir filas con precio NUEVO (changed-print) */
      tbody tr:not(.changed-print){display:none;}
    }
    tr.highlight td{
      background:#ecfdf5;
    }
    .price-input{
      width:100%;
      font-size:14px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#fefefe;
    }
    .price-input:focus{
      outline:2px solid var(--accent);
      outline-offset:1px;
      background:#f0fdf4;
    }
    @media(max-width:480px){
      th,td{padding:5px;}
      .toolbar button{flex:1 1 auto;justify-content:center;}
    }
  </style>
</head>
<body>

  <div class="card no-print">
    <h1>üí∂ ARSLAN ‚Äî Gestor externo de precios</h1>
    <div class="meta" id="metaInfo"></div>
    <div class="hint">
      Esta p√°gina se abre con un link tipo <code>?data=...</code> comprimido con LZ-String (igual que reparto).  
      Introduce solo precios nuevos donde quieras actualizarlos.
    </div>
  </div>

  <div class="card no-print">
    <div class="toolbar">
      <button class="primary" id="btnExportTxt">üìÑ TXT precios nuevos</button>
      <button id="btnCopyJson">üìã Copiar JSON precios nuevos</button>
      <button onclick="window.print()">üßæ Imprimir / PDF</button>
      <button class="danger" id="btnClearSelection">‚ùå Limpiar selecci√≥n</button>
    </div>

    <div class="filter-row">
      <div>
        <div class="hint">Filtrar texto (producto o proveedor)</div>
        <input type="text" id="filterText" placeholder="Ej: TOMATE, ESMO, YAME..." autocomplete="off"/>
      </div>
      <div>
        <div class="hint">Filtrar proveedor</div>
        <input type="text" id="filterProvider" placeholder="ESMO, MONTENEGRO, SIN PROVEEDOR..." autocomplete="off"/>
      </div>
      <div style="flex:0 0 auto;align-self:flex-end;display:flex;gap:6px">
        <button id="btnSelectAll">‚úÖ Marcar todos</button>
        <button id="btnUnselectAll">‚¨ú Desmarcar todos</button>
      </div>
    </div>

    <div class="hint">
      Atajos:
      <span class="badge">Enter</span> siguiente precio ¬∑
      <span class="badge">Shift+Enter</span> precio anterior ¬∑
      <span class="badge">‚Üë / ‚Üì</span> moverse entre precios.
    </div>
  </div>

  <div class="card">
    <div id="tableContainer"></div>
    <div class="totals no-print" id="totals"></div>
  </div>

  <script>
    // ========= Utilidades b√°sicas =========
    function getParam(name){
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }
    function escapeHTML(str){
      return String(str||'')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }

    // Normalizar precios para compararlos num√©ricamente
    function normalizePriceString(s){
      return String(s||'').replace(',', '.').trim();
    }
    function priceNumberOrNaN(s){
      const n = parseFloat(normalizePriceString(s));
      return isNaN(n) ? NaN : n;
    }
    function areSamePrice(a,b){
      const na = priceNumberOrNaN(a);
      const nb = priceNumberOrNaN(b);
      if(isNaN(na) || isNaN(nb)) return false;
      return Math.abs(na - nb) < 0.0001;
    }

    // ========= Carga de payload desde ?data=... =========
    function loadPayloadFromQuery(){
      const enc = getParam('data');
      if(!enc) return null;
      try{
        const json = LZString.decompressFromEncodedURIComponent(enc);
        if(!json) return null;
        const data = JSON.parse(json);
        return data;
      }catch(err){
        console.error('Error descomprimiendo/parseando data:', err);
        return null;
      }
    }

    // Demo si no hay data (para probar la p√°gina)
    const demoPayload = {
      title: "DEMO PRECIOS",
      dateISO: new Date().toISOString().split('T')[0],
      products: [
        { provider:"ESMO",          name:"TOMATE DANIELA", qty:35, oldPrice:"1.89" },
        { provider:"MONTENEGRO",    name:"ZANAHORIA",      qty:40, oldPrice:"0.65" },
        { provider:"SIN PROVEEDOR", name:"PRODUCTO RARO",  qty: 5, oldPrice:""     }
      ]
    };

    let payload = loadPayloadFromQuery() || demoPayload;

    // Estructura interna de filas
    // row = { id, provider, name, qty, oldPrice, newPrice, selected }
    let rows = [];

    function buildRows(){
      rows = (payload.products || []).map((p,idx)=>({
        id: 'r'+idx,
        provider: p.provider || "SIN PROVEEDOR",
        name: p.name || "",
        qty: p.qty ?? "",
        oldPrice: p.oldPrice || "",
        newPrice: "",      // aqu√≠ escribe el usuario
        selected: false
      }));
    }

    // ========= Render de la tabla =========
    const tableContainer = document.getElementById('tableContainer');
    const totalsEl = document.getElementById('totals');
    const filterTextEl = document.getElementById('filterText');
    const filterProvEl = document.getElementById('filterProvider');
    const metaInfoEl = document.getElementById('metaInfo');

    function renderMeta(){
      const title = payload.title || "PRECIOS";
      const date = payload.dateISO || new Date().toISOString().split('T')[0];
      const totalItems = rows.length;
      metaInfoEl.textContent = `${title} ‚Äî ${date} ¬∑ Productos: ${totalItems}`;
    }

    function getFilteredRows(){
      const text = (filterTextEl.value || '').trim().toLowerCase();
      const prov = (filterProvEl.value || '').trim().toLowerCase();
      return rows.filter(r=>{
        if(text){
          const hay = (r.name.toLowerCase().includes(text) ||
                      r.provider.toLowerCase().includes(text));
          if(!hay) return false;
        }
        if(prov){
          if(!r.provider.toLowerCase().includes(prov)) return false;
        }
        return true;
      });
    }

    function renderTable(){
      const filtered = getFilteredRows();
      if(!filtered.length){
        tableContainer.innerHTML = '<div class="hint">No hay productos que coincidan con el filtro.</div>';
        totalsEl.textContent = '';
        return;
      }

      let html = '<div style="overflow-x:auto"><table><thead><tr>' +
                 '<th class="no-print"></th>' +
                 '<th>Proveedor</th>' +
                 '<th>Producto</th>' +
                 '<th>Cantidad</th>' +
                 '<th>Precio actual</th>' +
                 '<th>Precio nuevo</th>' +
                 '</tr></thead><tbody>';

      filtered.forEach(r=>{
        const isUnassigned = (r.provider === "SIN PROVEEDOR");
        const tagClass = isUnassigned ? 'tag unassigned' : 'tag prov';
        const oldText = r.oldPrice ? (priceNumberOrNaN(r.oldPrice).toFixed(2) + '‚Ç¨') : '';
        const placeholder = r.oldPrice ? 'mantener' : 'nuevo precio';

        const hasNew = !!r.newPrice.trim();
        const changed = hasNew && !areSamePrice(r.oldPrice, r.newPrice);
        const highlight = r.selected || changed;
        const trClass = (highlight ? 'highlight ' : '') + (changed ? 'changed-print' : '');
        const checked = r.selected ? 'checked' : '';

        html += `<tr class="${trClass}" data-id="${r.id}">
          <td class="no-print" style="text-align:center">
            <input type="checkbox" data-role="select" data-id="${r.id}" ${checked}/>
          </td>
          <td><span class="${tagClass}">${escapeHTML(r.provider)}</span></td>
          <td>${escapeHTML(r.name)}</td>
          <td class="num">${escapeHTML(r.qty)}</td>
          <td class="num">${escapeHTML(oldText)}</td>
          <td>
            <input
              type="text"
              class="price-input"
              data-role="price"
              data-id="${r.id}"
              inputmode="decimal"
              pattern="[0-9]*[\\.,]?[0-9]*"
              autocomplete="off"
              placeholder="${escapeHTML(placeholder)}"
              value="${escapeHTML(r.newPrice)}"
            />
          </td>
        </tr>`;
      });

      html += '</tbody></table></div>';
      tableContainer.innerHTML = html;

      // Totales
      const totalListed = filtered.length;
      const totalSelected = filtered.filter(r=>r.selected).length;
      const totalWithNewPrice = filtered.filter(r=>{
        const hasNew = !!r.newPrice.trim();
        const changed = hasNew && !areSamePrice(r.oldPrice, r.newPrice);
        return changed;
      }).length;
      totalsEl.textContent =
        `Mostrando ${totalListed} productos ¬∑ `+
        `${totalSelected} marcados ¬∑ `+
        `${totalWithNewPrice} con precio nuevo`;

      // Eventos de selecci√≥n y cambio de precio
      tableContainer.querySelectorAll('input[data-role="select"]').forEach(cb=>{
        cb.addEventListener('change', onCheckboxChange);
      });
      tableContainer.querySelectorAll('input[data-role="price"]').forEach(input=>{
        input.addEventListener('input', onPriceInputChange);
      });
    }

    function onCheckboxChange(e){
      const id = e.target.dataset.id;
      const row = rows.find(r=>r.id === id);
      if(!row) return;
      row.selected = e.target.checked;
      renderTable();
    }

    function onPriceInputChange(e){
      const id = e.target.dataset.id;
      const row = rows.find(r=>r.id === id);
      if(!row) return;
      row.newPrice = e.target.value.trim();
      // Si escribe algo en precio nuevo, marcamos autom√°ticamente seleccionado
      row.selected = !!row.newPrice;
      renderTable();
      // Reenfocamos el input actual tras el re-render
      const again = tableContainer.querySelector('input[data-role="price"][data-id="'+id+'"]');
      if(again){
        const len = again.value.length;
        again.focus();
        again.setSelectionRange(len,len);
      }
    }

    // ========= Selecciones (marcar / desmarcar todo) =========
    document.getElementById('btnSelectAll').addEventListener('click', ()=>{
      getFilteredRows().forEach(r=>{ r.selected = true; });
      renderTable();
    });
    document.getElementById('btnUnselectAll').addEventListener('click', ()=>{
      getFilteredRows().forEach(r=>{ r.selected = false; });
      renderTable();
    });
    document.getElementById('btnClearSelection').addEventListener('click', ()=>{
      rows.forEach(r=>{
        r.selected = false;
        r.newPrice = '';
      });
      renderTable();
    });

    // ========= Filtros =========
    filterTextEl.addEventListener('input', ()=>renderTable());
    filterProvEl.addEventListener('input', ()=>renderTable());

    // ========= Exportar TXT precios nuevos =========
    document.getElementById('btnExportTxt').addEventListener('click', ()=>{
      const changed = rows.filter(r=>{
        const v = r.newPrice.trim();
        if(!r.selected) return false;
        if(!v) return false;
        if(areSamePrice(r.oldPrice, v)) return false;
        return true;
      });

      if(!changed.length){
        alert('No hay precios nuevos seleccionados.');
        return;
      }

      const lines = changed.map(r=>{
        const prov = r.provider === 'SIN PROVEEDOR' ? 'SIN PROVEEDOR' : r.provider;
        const oldTxt = r.oldPrice ? priceNumberOrNaN(r.oldPrice).toFixed(2) : '';
        return `${prov}\t${r.name}\t${r.qty}\t${oldTxt}\t${r.newPrice}`;
      });

      const today = (payload.dateISO || new Date().toISOString().split('T')[0]);
      const blob = new Blob([lines.join('\n')],{type:'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `precios_nuevos_${today}.txt`;
      a.click();
    });

    // ========= Copiar JSON precios nuevos =========
    document.getElementById('btnCopyJson').addEventListener('click', async ()=>{
      const changed = rows.filter(r=>{
        const v = r.newPrice.trim();
        if(!r.selected) return false;
        if(!v) return false;
        if(areSamePrice(r.oldPrice, v)) return false;
        return true;
      }).map(r=>({
        provider: r.provider,
        name: r.name,
        qty: r.qty,
        oldPrice: r.oldPrice,
        newPrice: r.newPrice
      }));

      if(!changed.length){
        alert('No hay precios nuevos seleccionados.');
        return;
      }

      const obj = {
        title: payload.title || 'PRECIOS',
        dateISO: payload.dateISO || new Date().toISOString().split('T')[0],
        changes: changed
      };

      try{
        await navigator.clipboard.writeText(JSON.stringify(obj,null,2));
        alert('JSON de precios nuevos copiado al portapapeles.');
      }catch(err){
        console.error(err);
        alert('No se pudo copiar al portapapeles. Copia manualmente el TXT si quieres.');
      }
    });

    // ========= Navegaci√≥n con teclado (Enter, Shift+Enter, ‚Üë, ‚Üì) =========
    function getPriceInputs(){
      return Array.from(document.querySelectorAll('input.price-input'));
    }
    function focusRelative(current, delta){
      const inputs = getPriceInputs();
      const idx = inputs.indexOf(current);
      if(idx === -1) return;
      let next = idx + delta;
      if(next < 0) next = 0;
      if(next >= inputs.length) next = inputs.length - 1;
      const target = inputs[next];
      if(target){
        const len = target.value.length;
        target.focus();
        target.setSelectionRange(len,len);
      }
    }

    document.addEventListener('keydown', (e)=>{
      const t = e.target;
      if(!(t instanceof HTMLInputElement)) return;
      if(!t.classList.contains('price-input')) return;

      if(e.key === 'Enter'){
        e.preventDefault();
        const delta = e.shiftKey ? -1 : +1;
        focusRelative(t, delta);
      }else if(e.key === 'ArrowDown'){
        e.preventDefault();
        focusRelative(t, +1);
      }else if(e.key === 'ArrowUp'){
        e.preventDefault();
        focusRelative(t, -1);
      }
    });

    // ========= INIT =========
    (function init(){
      buildRows();
      renderMeta();
      renderTable();
    })();
  </script>
</body>
</html>
