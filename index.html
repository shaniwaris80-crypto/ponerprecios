<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ARSLAN ‚Äî Poner precios (v2 compatible LISTAS)</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

  <style>
    :root{
      --ink:#111827; --muted:#6b7280; --border:#e5e7eb; --bg:#f9fafb; --panel:#ffffff;
      --kiwi:#16a34a; --kiwi2:#15803d; --warn:#f59e0b; --bad:#dc2626;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:12px;
      font-family:Poppins,system-ui,-apple-system,Segoe UI,Arial,sans-serif;
      background:var(--bg); color:var(--ink);
    }
    @media(min-width:768px){ body{padding:16px 24px;} }

    .top{
      background:var(--panel); border:1px solid var(--border);
      border-radius:16px; padding:12px; margin-bottom:12px;
      box-shadow:0 2px 6px rgba(0,0,0,.04);
    }
    h1{margin:0 0 4px; font-size:18px}
    .meta{font-size:12px;color:var(--muted)}
    .hint{font-size:12px;color:var(--muted); margin-top:6px; line-height:1.35}
    .card{
      background:var(--panel); border:1px solid var(--border);
      border-radius:16px; padding:12px; margin-bottom:12px;
      box-shadow:0 2px 6px rgba(0,0,0,.04);
    }
    .toolbar{
      display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px;
    }
    button{
      border-radius:12px; border:1px solid var(--border);
      padding:9px 12px; font-size:13px; background:#fff; color:var(--ink);
      cursor:pointer; display:inline-flex; align-items:center; gap:6px;
      touch-action:manipulation;
    }
    button.primary{
      background:linear-gradient(135deg,var(--kiwi),var(--kiwi2));
      border-color:var(--kiwi2); color:#fff;
    }
    button.danger{
      border-color:#fecaca; color:#b91c1c; background:#fef2f2;
    }
    .filters{
      display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px;
    }
    .filters > div{flex:1 1 180px}
    input[type="text"]{
      width:100%;
      border-radius:12px; border:1px solid var(--border);
      padding:10px 12px; font-size:14px; background:#fff;
    }

    table{ width:100%; border-collapse:collapse; font-size:12px; }
    th,td{ border:1px solid var(--border); padding:7px; vertical-align:top; }
    th{
      background:#11182708; text-transform:uppercase; letter-spacing:.05em; font-size:11px;
      color:#374151;
    }
    td.num{text-align:right}
    .tag{
      display:inline-block; padding:2px 8px; border-radius:999px;
      font-size:11px; border:1px solid var(--border); background:#fff; white-space:nowrap;
    }
    .tag.prov{ background:#ecfdf5; border-color:#bbf7d0; color:#166534; }
    .tag.un{ background:#fefce8; border-color:#facc15; color:#854d0e; }

    .price-input{
      width:100%;
      border-radius:12px;
      border:1px solid var(--border);
      padding:10px 12px;
      font-size:16px;
      background:#fff;
    }
    .price-input:focus{
      outline:2px solid var(--kiwi); outline-offset:1px;
      background:#f0fdf4;
    }

    tr.changed td{ background:#ecfdf5; }
    tr.same td{ background:#fff; }
    tr.bad td{ background:#fff5f5; }

    .totals{
      margin-top:10px;
      font-size:12px;
      color:#374151;
    }

    /* PRINT: solo filas con precio NUEVO */
    @media print{
      .no-print{display:none !important;}
      body{padding:10mm; background:#fff;}
      .card{border:none; box-shadow:none; padding:0; margin:0 0 8px;}
      tbody tr:not(.print-me){display:none;}
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
    }
    .cell{
      border:1px solid #11182722;
      border-radius:14px;
      padding:12px;
    }
    .cell .name{ font-weight:700; font-size:12px; }
    .cell .price{ margin-top:10px; font-size:20px; font-weight:900; color:var(--kiwi); }
    @media(max-width:520px){
      .grid{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>

<body>

  <div class="top no-print">
    <h1>üí∂ ARSLAN ‚Äî Poner precios (v2)</h1>
    <div class="meta" id="metaInfo"></div>
    <div class="hint">
      ‚úÖ Compatible con LISTAS (usa <b>arslan_v34_prices</b>)<br>
      Atajos: <b>Enter</b> siguiente ¬∑ <b>Shift+Enter</b> anterior ¬∑ <b>‚Üë/‚Üì</b> mover.
      <br>‚ö†Ô∏è Solo se exporta/imprime lo que tenga <b>precio NUEVO</b>.
    </div>
  </div>

  <div class="card no-print">
    <div class="toolbar">
      <button class="primary" id="btnSaveAll">üíæ Guardar cambios</button>
      <button id="btnExportTxt">üìÑ TXT precios nuevos</button>
      <button id="btnExportWa">üì≤ WhatsApp precios nuevos</button>
      <button onclick="window.print()">üßæ PDF (solo nuevos)</button>
      <button class="danger" id="btnClearNew">‚ùå Limpiar precios nuevos</button>
    </div>

    <div class="filters">
      <div>
        <div class="hint">Filtrar por producto/proveedor</div>
        <input type="text" id="filterText" placeholder="Ej: TOMATE, ESMO, YAME..." autocomplete="off">
      </div>
      <div>
        <div class="hint">Filtrar proveedor</div>
        <input type="text" id="filterProv" placeholder="ESMO, MONTENEGRO, SIN PROVEEDOR..." autocomplete="off">
      </div>
    </div>

    <div class="hint" id="statusHint"></div>
  </div>

  <div class="card">
    <div id="tableWrap"></div>
    <div class="totals no-print" id="totals"></div>

    <!-- mini ‚Äúpreview‚Äù cuadr√≠cula para imprimir bonito si quieres -->
    <div id="printGrid" style="display:none;margin-top:10px"></div>
  </div>

<script>
/* =========================================================
   COMPATIBILIDAD LISTAS
   LISTAS usa:
   LS.PRICES = 'arslan_v34_prices'
   pricesDB[normKey] = { name, price, updatedAt }
========================================================= */
const LS_PRICES_KEY = 'arslan_v34_prices';

/* ========= Utils ========= */
function getParam(name){
  return new URLSearchParams(location.search).get(name);
}
function escapeHTML(str){
  return String(str||'')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}
function removeDiacriticsUpper(s){
  return String(s||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/√±/g,'N').replace(/√ë/g,'N')
    .toUpperCase();
}
function normKey(s){
  return removeDiacriticsUpper(s)
    .replace(/[^A-Z0-9\s]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}
function toFixed2(n){
  return (Math.round(n*100)/100).toFixed(2);
}
function priceNumberOrNaN(v){
  const n = parseFloat(String(v||'').replace(',','.').trim());
  return isNaN(n)? NaN : n;
}
function samePrice(a,b){
  const na = priceNumberOrNaN(a);
  const nb = priceNumberOrNaN(b);
  if(isNaN(na) || isNaN(nb)) return false;
  return Math.abs(na-nb) < 0.0001;
}
function nowISO(){
  const d = new Date();
  return d.toISOString().split('T')[0];
}

/* ========= Load/Save pricesDB (LISTAS format) ========= */
function loadPricesDB(){
  try{
    const obj = JSON.parse(localStorage.getItem(LS_PRICES_KEY)||'{}');
    return (obj && typeof obj==='object') ? obj : {};
  }catch{ return {}; }
}
function savePricesDB(db){
  localStorage.setItem(LS_PRICES_KEY, JSON.stringify(db));
}

/* ========= Payload from LISTAS (?data= compressed) ========= */
function loadPayload(){
  const enc = getParam('data');
  if(!enc) return null;
  try{
    const json = LZString.decompressFromEncodedURIComponent(enc);
    if(!json) return null;
    return JSON.parse(json);
  }catch(e){
    console.error(e);
    return null;
  }
}

/* ========= State ========= */
let payload = loadPayload() || { title:'PRECIOS', dateISO: nowISO(), products:[] };

// rows: { id, provider, name, qty, oldPrice, newPrice }
let rows = [];
let pricesDB = loadPricesDB();

const metaInfo = document.getElementById('metaInfo');
const tableWrap = document.getElementById('tableWrap');
const totalsEl = document.getElementById('totals');
const filterTextEl = document.getElementById('filterText');
const filterProvEl = document.getElementById('filterProv');
const statusHint = document.getElementById('statusHint');
const printGrid = document.getElementById('printGrid');

function buildRows(){
  const arr = Array.isArray(payload.products) ? payload.products : [];
  rows = arr.map((p,idx)=>{
    const name = removeDiacriticsUpper(p.name||'').trim();
    const k = normKey(name);
    const existing = pricesDB[k] && pricesDB[k].price ? String(pricesDB[k].price) : '';
    const oldFromPayload = (p.oldPrice!=null && String(p.oldPrice).trim()!=='') ? String(p.oldPrice) : '';
    // prioridad: lo que ya tienes guardado en localStorage
    const oldPrice = existing || oldFromPayload || '';
    return {
      id: 'r'+idx,
      provider: p.provider || 'SIN PROVEEDOR',
      name: name || (p.name||''),
      qty: (p.qty!=null? p.qty : ''),
      oldPrice,
      newPrice: '' // el usuario escribe aqu√≠
    };
  });
}

function renderMeta(){
  const t = payload.title || 'PRECIOS';
  const d = payload.dateISO || nowISO();
  metaInfo.textContent = `${t} ‚Äî ${d} ¬∑ Productos: ${rows.length} ¬∑ Guardado en localStorage: ${LS_PRICES_KEY}`;
}

function getFilteredRows(){
  const ft = (filterTextEl.value||'').trim().toLowerCase();
  const fp = (filterProvEl.value||'').trim().toLowerCase();
  return rows.filter(r=>{
    if(ft){
      const hay = (r.name||'').toLowerCase().includes(ft) || (r.provider||'').toLowerCase().includes(ft);
      if(!hay) return false;
    }
    if(fp){
      if(!(r.provider||'').toLowerCase().includes(fp)) return false;
    }
    return true;
  });
}

function renderTable(){
  const filtered = getFilteredRows();
  if(!filtered.length){
    tableWrap.innerHTML = `<div class="hint">No hay productos que coincidan con el filtro.</div>`;
    totalsEl.textContent = '';
    return;
  }

  let html = `<div style="overflow-x:auto"><table>
    <thead>
      <tr>
        <th>Proveedor</th>
        <th>Producto</th>
        <th class="num">Cant.</th>
        <th class="num">Precio actual</th>
        <th class="num">Precio nuevo</th>
      </tr>
    </thead>
    <tbody>`;

  filtered.forEach(r=>{
    const isUn = (r.provider === 'SIN PROVEEDOR');
    const tagClass = isUn ? 'tag un' : 'tag prov';
    const oldTxt = r.oldPrice ? (isNaN(priceNumberOrNaN(r.oldPrice)) ? '' : (toFixed2(priceNumberOrNaN(r.oldPrice))+'‚Ç¨')) : '';

    const hasNew = String(r.newPrice||'').trim() !== '';
    const changed = hasNew && !samePrice(r.oldPrice, r.newPrice);
    const bad = hasNew && isNaN(priceNumberOrNaN(r.newPrice));
    const trClass = bad ? 'bad' : (changed ? 'changed print-me' : 'same');
    const placeholder = r.oldPrice ? 'mantener' : 'nuevo';

    html += `<tr class="${trClass}" data-id="${r.id}">
      <td><span class="${tagClass}">${escapeHTML(r.provider)}</span></td>
      <td><b>${escapeHTML(r.name)}</b></td>
      <td class="num">${escapeHTML(r.qty)}</td>
      <td class="num">${escapeHTML(oldTxt)}</td>
      <td class="num">
        <input
          class="price-input price-field"
          type="number"
          step="0.01"
          inputmode="decimal"
          pattern="[0-9]*[\\.,]?[0-9]*"
          autocomplete="off"
          placeholder="${escapeHTML(placeholder)}"
          data-id="${r.id}"
          value="${escapeHTML(r.newPrice)}"
        />
      </td>
    </tr>`;
  });

  html += `</tbody></table></div>`;
  tableWrap.innerHTML = html;

  // eventos
  const inputs = Array.from(document.querySelectorAll('.price-field'));
  inputs.forEach((inp, i)=>{
    inp.addEventListener('input', ()=>{
      const id = inp.dataset.id;
      const row = rows.find(x=>x.id===id);
      if(!row) return;
      row.newPrice = String(inp.value||'').trim();
      updateTotals();
      // no re-render aqu√≠ para no perder foco
      markRowClass(inp, row);
    });

    inp.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){
        e.preventDefault();
        const delta = e.shiftKey ? -1 : +1;
        focusRelative(inp, delta);
      }else if(e.key==='ArrowDown'){
        e.preventDefault(); focusRelative(inp, +1);
      }else if(e.key==='ArrowUp'){
        e.preventDefault(); focusRelative(inp, -1);
      }
    });
  });

  updateTotals();
  buildPrintGrid();
  statusHint.textContent = `Tip: escribe precio ‚Üí Enter ‚Üí siguiente. Luego pulsa ‚ÄúGuardar cambios‚Äù.`;
}

function markRowClass(inp, row){
  const tr = inp.closest('tr');
  if(!tr) return;
  const hasNew = String(row.newPrice||'').trim() !== '';
  const changed = hasNew && !samePrice(row.oldPrice, row.newPrice);
  const bad = hasNew && isNaN(priceNumberOrNaN(row.newPrice));
  tr.classList.remove('bad','changed','same','print-me');
  if(bad) tr.classList.add('bad');
  else if(changed){ tr.classList.add('changed','print-me'); }
  else tr.classList.add('same');
}

function getPriceInputs(){
  return Array.from(document.querySelectorAll('.price-field'));
}
function focusRelative(current, delta){
  const inputs = getPriceInputs();
  const idx = inputs.indexOf(current);
  if(idx<0) return;
  let next = idx + delta;
  if(next<0) next = 0;
  if(next>=inputs.length) next = inputs.length-1;
  const t = inputs[next];
  if(t){
    t.focus();
    const len = t.value.length;
    try{ t.setSelectionRange(len,len); }catch{}
  }
}

function getChanges(){
  return rows.filter(r=>{
    const v = String(r.newPrice||'').trim();
    if(!v) return false;
    if(isNaN(priceNumberOrNaN(v))) return false;
    if(samePrice(r.oldPrice, v)) return false;
    return true;
  }).map(r=>({
    provider: r.provider,
    name: r.name,
    qty: r.qty,
    oldPrice: r.oldPrice,
    newPrice: toFixed2(priceNumberOrNaN(r.newPrice))
  }));
}

function updateTotals(){
  const f = getFilteredRows();
  const changesAll = getChanges();
  const changesFiltered = f.filter(r=>{
    const v = String(r.newPrice||'').trim();
    if(!v) return false;
    if(isNaN(priceNumberOrNaN(v))) return false;
    if(samePrice(r.oldPrice, v)) return false;
    return true;
  }).length;

  totalsEl.textContent =
    `Mostrando ${f.length} ¬∑ `+
    `${changesFiltered} cambios en pantalla ¬∑ `+
    `${changesAll.length} cambios totales (se exportar√°n/imprimir√°n).`;
}

function buildPrintGrid(){
  const ch = getChanges();
  if(!ch.length){
    printGrid.style.display = 'none';
    printGrid.innerHTML = '';
    return;
  }
  printGrid.style.display = 'block';
  printGrid.innerHTML =
    `<div class="grid">` +
    ch.map(x=>{
      const p = toFixed2(priceNumberOrNaN(x.newPrice)).replace('.',',') + '‚Ç¨';
      return `<div class="cell">
        <div class="name">${escapeHTML(x.name)}</div>
        <div class="price">${escapeHTML(p)}</div>
      </div>`;
    }).join('') +
    `</div>`;
}

/* ========= Actions ========= */
document.getElementById('btnSaveAll').addEventListener('click', ()=>{
  const changes = getChanges();
  if(!changes.length){
    alert('No hay precios nuevos para guardar.');
    return;
  }

  // guardamos en el formato exacto que LISTAS usa
  let db = loadPricesDB();

  changes.forEach(c=>{
    const k = normKey(c.name);
    db[k] = db[k] || { name:c.name, price:'', updatedAt:0 };
    db[k].name = db[k].name || c.name;
    db[k].price = String(c.newPrice);      // "1.23"
    db[k].updatedAt = Date.now();
  });

  savePricesDB(db);
  pricesDB = db;

  // tras guardar, convertimos "oldPrice" y limpiamos newPrice (para que ya no salga como cambio)
  rows.forEach(r=>{
    const k = normKey(r.name);
    if(db[k] && db[k].price){
      r.oldPrice = String(db[k].price);
      r.newPrice = '';
    }
  });

  renderTable();
  alert('‚úÖ Precios guardados en LISTAS (localStorage arslan_v34_prices). Ya puedes volver a LISTAS y se ver√°n.');
});

document.getElementById('btnClearNew').addEventListener('click', ()=>{
  if(!confirm('¬øBorrar todos los precios NUEVOS escritos (no borra los guardados)?')) return;
  rows.forEach(r=>r.newPrice='');
  renderTable();
});

document.getElementById('btnExportTxt').addEventListener('click', ()=>{
  const changes = getChanges();
  if(!changes.length){ alert('No hay precios nuevos.'); return; }
  const lines = changes.map(c=>{
    // formato simple
    return `${c.name}\t${String(c.newPrice).replace('.',',')}‚Ç¨`;
  });
  const blob = new Blob([lines.join('\n')], {type:'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `PRECIOS_NUEVOS_${payload.dateISO||nowISO()}.txt`;
  a.click();
});

document.getElementById('btnExportWa').addEventListener('click', ()=>{
  const changes = getChanges();
  if(!changes.length){ alert('No hay precios nuevos.'); return; }
  let msg = `üí∂ *PRECIOS NUEVOS* (${payload.dateISO||nowISO()})\n\n`;
  changes.forEach(c=>{
    msg += `- ${c.name}: ${String(c.newPrice).replace('.',',')}‚Ç¨\n`;
  });
  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
});

// filtros
filterTextEl.addEventListener('input', ()=>renderTable());
filterProvEl.addEventListener('input', ()=>renderTable());

/* ========= INIT ========= */
(function init(){
  buildRows();
  renderMeta();
  renderTable();
})();
</script>

</body>
</html>
